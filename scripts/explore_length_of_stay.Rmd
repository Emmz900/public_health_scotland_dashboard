---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(janitor)
library(here)
library(infer)

data <- clean_names(read_csv(here("raw_data/inpatient_and_daycase_by_nhs_board_of_treatment_age_and_sex.csv")))
```
```{r}
data %>% 
  filter(is.na(average_length_of_stay_qf)) %>% 
  distinct(average_length_of_stay)
```

```{r}
data %>% 
  filter(
    admission_type == "All Inpatients" & 
      str_detect(quarter, "201")
  ) %>% 
  ggplot(aes(average_length_of_stay)) +
  geom_histogram()
```

```{r}
bootstrap_resample <- data %>% 
  filter(admission_type == "All Inpatients" & str_detect(quarter, "201")) %>% 
  select(average_length_of_stay) %>% 
  specify(response = average_length_of_stay) %>% 
  generate(reps = 10000, type = "bootstrap") %>% 
  calculate(stat = "mean")

bootstrap_ci <- bootstrap_resample %>% 
  get_ci(level = 0.95, type = "percentile")

bootstrap_resample %>% 
  visualise(bins = 30) +
  shade_ci(bootstrap_ci)

bootstrap_ci

```
```{r}
mean_stay <- data %>% 
  filter(admission_type == "All Inpatients" & str_detect(quarter, "201")) %>% 
  summarise(avg_stay = mean(average_length_of_stay, na.rm = TRUE)) %>% 
  pull()

upper_ci <- bootstrap_ci %>% 
  select(upper_ci) %>% 
  pull()

lower_ci <- bootstrap_ci %>% 
  select(lower_ci) %>% 
  pull()
```



```{r}
data %>% 
  filter(admission_type == "All Inpatients" & str_detect(quarter, "201")) %>% 
  summarise(avg_stay = mean(average_length_of_stay, na.rm = TRUE))
```

```{r}
data %>% 
  # admission type, health board, age, sex, quarter
  filter(
    admission_type == "All Inpatients" & 
      !is.na(hbqf) & 
      #age == "10-19 years" &
      str_detect(quarter, "202")
  ) %>% 
  group_by(quarter, sex) %>% 
  summarise(avg_stay = mean(average_length_of_stay)) %>% 
  ggplot(aes(quarter, avg_stay, fill = sex)) +
  geom_col(position = "dodge") +
  geom_rect(aes(ymax = upper_ci, ymin = lower_ci, xmin = 0, xmax = Inf), fill = "red", alpha = 0.2) +
  geom_hline(aes(yintercept = mean_stay)) +  
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
data %>% 
  # admission type, health board, age, sex, quarter
  filter(
    admission_type == "All Inpatients" & 
      !is.na(hbqf) &
      age == "40-49 years" &
      str_detect(quarter, "201")
  ) %>% 
  summarise(avg_stay_2 = sum(length_of_stay)/sum(stays)) %>% 
  pull()
```


